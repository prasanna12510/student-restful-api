name: cloudsre-hello-world-app-code-deploy-play
on:
  push:
    tags:
      - CLOUDSRE-HELLO-WORLD-PLAY-CODE-*
    paths:
      - 'services/cloudsre-hello-world-app/code-deploy/**'

jobs:
  cloudsre-hello-world-app-image-build-job-play:
    runs-on: ubuntu-latest
    steps:
      - name: checkout public repo
        uses: actions/checkout@master

      - name: push image to our Private Hub
        run:  |
          #export APP_TAG=${GITHUB_REF##*/} && make docker-push
          export APP_TAG="CLOUDSRE-HELLO-WORLD-PLAY-CODE-CS-887-v0.1"
        working-directory: services/cloudsre-hello-world-app/code-deploy/src/
        env:
          DOCKER_TOKEN: ${{ secrets.QUAY_REGISTRY_TOKEN }}
          SSH_KEY: ${{ secrets.DEPLOYER_KEY_PRIV }}
          SSH_KEY_PUB: ${{ secrets.DEPLOYER_KEY_PUB }}
          GITHUB_REF: ${{ toJson(github.ref) }}

  cloudsre-hello-world-app-ecs-deployment-play:
    runs-on: ubuntu-latest
    needs: cloudsre-hello-world-app-image-build-job-play
    steps:
      - name: checkout public repo
        uses: actions/checkout@master

      - name: Get the latest terraform version
        run: make terraform-install

      - name: cloudsre-hello-world-app apply terraform
        run: |
          #export APP_TAG=${GITHUB_REF##*/} && sed -i -e "s/APP_TAG/$APP_TAG/g" *.tf
          export APP_TAG="CLOUDSRE-HELLO-WORLD-PLAY-CODE-CS-887-v0.1" && sed -i -e "s/APP_TAG/$APP_TAG/g" *.tf
          make terraform-apply
        working-directory: services/cloudsre-hello-world-app/code-deploy/
        env:
          TF_IN_AUTOMATION: true
          TF_WORKSPACE: play
          TF_TOKEN_CLOUD_SRE: ${{ secrets.TF_TOKEN_CLOUD_SRE }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_PLAY_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_PLAY_SECRET_KEY }}
          GITHUB_REF: ${{ toJson(github.ref) }}
